<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Choix du Niveau</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">

    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <div class="scrolling-background"></div>
    <div class="container">
        <div id="accueil">
            <h1>CHASSE AUX GRAINS</h1>

            <div id="video-container">
                <iframe
                    id="youtube-intro-video"
                    width="560"
                    height="315"
                    src="https://www.youtube.com/embed/vLGYsOoNtFE?enablejsapi=1&rel=0&version=3&playerapiid=ytplayer"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    title="Vidéo de présentation du Quiz Grains de Beauté">
                </iframe>
                <div id="video-overlay">Cliquez pour lancer la vidéo</div>
            </div>
            <p>Choisissez un niveau :</p>
            <button onclick="chargerNiveau(1)">Niveau 1</button>
            <button onclick="chargerNiveau(2)">Niveau 2</button>
            <button onclick="chargerNiveau(3)">Niveau 3</button>
        </div>

        <div id="jeu" style="display: none;">
            </div>

        <div id="credit-page" style="display: none;">
            </div>

    </div>

    <button id="btn-credit" onclick="affichercredit()">Crédits</button>

    <script>
        const staticBaseUrl = "{{ url_for('static', filename='') }}";
        let currentLevelScript = null; // Gardé pour la cohérence, mais pas utilisé directement ici
        let player; // Variable globale pour le lecteur YouTube

        // GESTION DU FOND DÉFILANT : Fonction utilitaire
        function toggleScrollingBackground(show) {
            const background = document.querySelector('.scrolling-background');
            if (background) {
                background.style.display = show ? 'block' : 'none';
            }
        }

        function chargerNiveau(numero) {
            toggleScrollingBackground(false); // Masque le fond

            // Pause la vidéo YouTube avant de quitter la page d'accueil
            if (player && typeof player.pauseVideo === 'function') {
                player.pauseVideo();
                player.seekTo(0); // Remet la vidéo au début
            }

            document.getElementById("accueil").style.display = "none";
            document.getElementById("jeu").style.display = "block";
            document.getElementById("jeu").innerHTML = ''; // Nettoie le contenu précédent

            const script = document.createElement("script");
            script.src = staticBaseUrl + "niveau" + numero + ".js";
            document.body.appendChild(script);

            script.onload = () => {
                console.log(`Script niveau${numero}.js chargé et exécuté.`);
            };
            script.onerror = () => {
                console.error(`Erreur lors du chargement de niveau${numero}.js`);
            };
        }

        function affichercredit() {
            toggleScrollingBackground(false); // Masque le fond

            // Pause la vidéo YouTube avant de quitter la page d'accueil
            if (player && typeof player.pauseVideo === 'function') {
                player.pauseVideo();
                player.seekTo(0);
            }
            document.getElementById("accueil").style.display = "none";
            document.getElementById("jeu").style.display = "none";
            const creditPage = document.getElementById("credit-page");
            creditPage.style.display = "block";
            // Important : Si "credit()" est une page Flask séparée qui recharge le navigateur,
            // les styles et l'état de la vidéo seront réinitialisés.
            // Si c'est un contenu affiché dynamiquement, cela fonctionne.
            // Étant donné votre `window.location.href`, cela rechargera.
            window.location.href = "{{ url_for('credit') }}";
        }

        function retourMenu() {
            toggleScrollingBackground(true); // Réaffiche le fond
            // Le rechargement de la page réinitialisera l'état de la vidéo YouTube et l'affichage des sections
            window.location.href = "{{ url_for('index') }}";
        }

        // --- GESTION DE L'API YOUTUBE ---

        // 1. Cette fonction est appelée par l'API YouTube lorsque le code de l'API est prêt.
        // C'est le point d'entrée pour interagir avec le lecteur.
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-intro-video', {
                events: {
                    'onReady': onPlayerReady,          // Appelé lorsque le lecteur est prêt
                    'onStateChange': onPlayerStateChange // Appelé lorsque l'état de la vidéo change
                }
            });
        }

        // 2. Cette fonction est appelée quand le lecteur vidéo est prêt à recevoir des commandes.
        function onPlayerReady(event) {
            const videoOverlay = document.getElementById('video-overlay');
            event.target.mute();      // Met la vidéo en sourdine par défaut
            event.target.setVolume(0); // Volume à zéro
            videoOverlay.style.opacity = '1';       // S'assure que l'overlay est visible
            videoOverlay.style.pointerEvents = 'auto'; // S'assure qu'il est cliquable
            // Optionnel: charger la vidéo explicitement si vous n'êtes pas sûr que l'attribut src est suffisant
            // event.target.loadVideoById('VOTRE_VIDEO_ID'); // Remplacez par l'ID de votre vidéo
        }

        // 3. Cette fonction est appelée à chaque changement d'état de la vidéo.
        function onPlayerStateChange(event) {
            const videoOverlay = document.getElementById('video-overlay');
            const videoContainer = document.getElementById('video-container');

            if (event.data === YT.PlayerState.PLAYING) {
                videoOverlay.style.opacity = '0';
                videoOverlay.style.pointerEvents = 'none'; // Rend l'overlay non cliquable
                event.target.setVolume(100); // Rétablit le volume lors de la lecture
                videoContainer.style.cursor = 'default';
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.BUFFERING) {
                videoOverlay.textContent = 'Cliquez pour continuer';
                videoOverlay.style.opacity = '1';
                videoOverlay.style.pointerEvents = 'auto';
                event.target.setVolume(0); // Mute quand en pause/mise en tampon
                videoContainer.style.cursor = 'pointer';
            } else if (event.data === YT.PlayerState.ENDED) {
                videoOverlay.textContent = 'Cliquez pour rejouer';
                videoOverlay.style.opacity = '1';
                videoOverlay.style.pointerEvents = 'auto';
                event.target.seekTo(0); // Remet la vidéo au début
                event.target.setVolume(0); // Mute à la fin
                videoContainer.style.cursor = 'pointer';
            }
        }

        // 4. Gérer le clic sur le conteneur de la vidéo (ou l'overlay)
        document.addEventListener('DOMContentLoaded', function() {
            const videoContainer = document.getElementById('video-container');
            if (videoContainer) {
                videoContainer.addEventListener('click', () => {
                    if (player && typeof player.getPlayerState === 'function') {
                        const playerState = player.getPlayerState();
                        if (playerState === YT.PlayerState.PAUSED || playerState === YT.PlayerState.ENDED || playerState === YT.PlayerState.BUFFERING) {
                            player.playVideo();
                        } else if (playerState === YT.PlayerState.PLAYING) {
                            player.pauseVideo();
                        }
                    } else {
                        console.warn("Le lecteur YouTube n'est pas encore initialisé.");
                    }
                });
            } else {
                console.warn("Conteneur vidéo #video-container non trouvé dans le DOM.");
            }
        });
    </script>
</body>
</html>
